#!/bin/bash
# Generated by pwa-forge
# Scheme: {{ scheme }}://
# Target browser: {{ browser }}

raw="$1"

if [ -z "$raw" ]; then
  echo "Error: No URL provided" >&2
  exit 1
fi

# Remove scheme prefix
payload="${raw#{{ scheme }}:}"
payload="${payload#//}"

# Decode URL
decoded=$(python3 -c "
import sys
import urllib.parse as up
try:
    print(up.unquote(sys.argv[1]))
except Exception as e:
    print('Error decoding URL:', e, file=sys.stderr)
    sys.exit(1)
" "$payload")

if [ $? -ne 0 ]; then
  exit 1
fi

# Validate URL scheme
case "$decoded" in
  http://*|https://*)
    # Log the action (optional)
    logger -t pwa-forge-handler "Opening: $decoded"

    # Launch browser
    exec "{{ browser_exec }}" --new-window "$decoded"
    ;;
  *)
    echo "Error: Invalid URL scheme: $decoded" >&2
    logger -t pwa-forge-handler "Rejected URL: $decoded"
    exit 1
    ;;
esac
